{% extends 'base.html' %}
{% block content %}
<h1>Note (Scribe)</h1>
<p class="muted">Obtain explicit patient consent before recording. Audio is chunked and sent securely; only transcripts are retained.</p>

<div class="card" style="max-width: 840px;">
  <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap: wrap;">
    <div>
      <label for="patientId">Patient DFN</label>
      <input type="text" id="patientId" placeholder="e.g., 123" />
    </div>
    <div style="display:flex; align-items:center; gap:8px; margin-top: 22px;">
      <input type="checkbox" id="consent" />
      <label for="consent">I have obtained explicit verbal consent</label>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px;">
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>
  </div>
  <div style="margin-top: 12px; display:flex; align-items:center; gap:10px;">
    <span id="recDot" style="width:10px;height:10px;border-radius:50%;background:#d1d5db;display:inline-block;" aria-label="not recording"></span>
    <span id="status" class="muted"></span>
  </div>
</div>

<div class="card" style="max-width: 840px; margin-top: 16px;">
  <h3 style="margin:0 0 8px 0;">Live transcript</h3>
  <pre id="transcript" style="white-space:pre-wrap; min-height: 120px;">(waiting…)</pre>
</div>

<script type="module">
  import { qs } from '/static/js/ui.js';
  // note.js is a non-module script; ensure it's loaded in base.html or include here via classic <script>.
</script>
<script>
  // For Azure stability across browsers, prefer WAV fallback universally for now.
  window.FORCE_WAV_RECORDING = true;
</script>
<script src="/static/js/note.js"></script>
<script>
  (function(){
    const pidEl = document.getElementById('patientId');
    const consentEl = document.getElementById('consent');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const recDot = document.getElementById('recDot');
    const transcriptEl = document.getElementById('transcript');

    let timer = null;

    function setDot(active){
      recDot.style.background = active ? '#ef4444' : '#d1d5db';
      recDot.setAttribute('aria-label', active ? 'recording' : 'not recording');
    }

    function updateUI(state){
      // state: { active, supported, ready, consent, uploadedSeq, mimeType }
      setDot(!!state.active);
      stopBtn.disabled = !state.active;
      startBtn.disabled = !!state.active;
      if (!state.supported) {
        statusEl.textContent = 'Recording not supported in this browser.';
      }
      if (typeof state.uploadedSeq === 'number'){
        statusEl.textContent = 'Uploaded #' + state.uploadedSeq;
      }
    }

    function getGeneration(){
      return sessionStorage.getItem('patient_generation') || '';
    }

    const recorder = new window.NoteRecorder({
      getGeneration,
      onStatus: updateUI,
      onError: (e) => { statusEl.textContent = (e && e.message) ? e.message : 'error'; },
      chunkMs: 4000
    });

    function setPatient(){
      const pid = (pidEl.value || '').trim();
      recorder.setPatient(pid || null);
      // Rotate generation per patient entry
      if (pid){
        const gen = String(Date.now());
        sessionStorage.setItem('patient_generation', gen);
      } else {
        sessionStorage.removeItem('patient_generation');
      }
    }

    pidEl.addEventListener('change', setPatient);
    consentEl.addEventListener('change', (e) => recorder.setConsent(!!e.target.checked));

    startBtn.addEventListener('click', async () => {
      try {
        setPatient();
        if (!recorder.patientId) { statusEl.textContent = 'Enter a patient DFN.'; return; }
        if (!consentEl.checked) { statusEl.textContent = 'Consent is required to record.'; return; }
        statusEl.textContent = 'Starting…';
        await recorder.start();
        const startedAt = Date.now();
        timer = setInterval(async () => {
          // Poll transcript periodically
          try {
            const sid = window.currentScribeSessionId;
            if (!sid) return;
            const resp = await fetch(`/api/scribe/status?session_id=${encodeURIComponent(sid)}`, { credentials: 'same-origin' });
            if (resp.ok){
              const data = await resp.json();
              transcriptEl.textContent = data.transcript || '';
            }
          } catch {}
        }, 1500);
        statusEl.textContent = 'Recording';
      } catch (e){
        statusEl.textContent = (e && e.message) ? e.message : 'failed to start';
      }
    });

    stopBtn.addEventListener('click', async () => {
      try {
        statusEl.textContent = 'Stopping…';
        await recorder.stop();
      } catch (e){ /* noop */ }
      finally {
        if (timer) { clearInterval(timer); timer = null; }
        statusEl.textContent = 'Stopped';
      }
    });

    // Simulate patient switch: if the input changes while recording, force stop
    pidEl.addEventListener('input', () => {
      if (recorder.active) {
        recorder.onPatientSwitch();
        if (timer) { clearInterval(timer); timer = null; }
        statusEl.textContent = 'Patient changed; recording stopped.';
        setDot(false);
      }
    });
  })();
</script>
{% endblock %}
