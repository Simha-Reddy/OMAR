<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OMAR Refactor</title>
    <link rel="stylesheet" href="/static/styles/theme.css" />
    <style>
      body { font-family: Segoe UI, Arial, sans-serif; margin: 24px; }
      code { background:#f3f4f6; padding:2px 6px; border-radius:4px; }
      .card { border:1px solid #e5e7eb; border-radius:8px; padding:16px; margin-top:16px; background:#fff; }
      .row { display:flex; gap:12px; align-items:center; }
      .row > * { flex: 1 1 auto; }
      .row .narrow { flex: 0 0 180px; }
      label { font-weight:600; font-size:14px; color:#374151; display:block; margin-bottom:6px; }
      input[type="text"], textarea { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; }
      textarea { min-height: 120px; }
      button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:10px 14px; font-weight:600; cursor:pointer; }
      button[disabled]{ opacity:0.6; cursor:not-allowed; }
      .muted { color:#6b7280; }
      .answer { white-space:pre-wrap; line-height:1.5; }
      .citations { margin-top:8px; }
      .citation { font-size: 13px; color:#374151; padding:8px 10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; margin-top:6px; }
      details { margin-top:10px; }
      details summary { cursor:pointer; font-weight:600; }
      .debug-pre { max-height:300px; overflow:auto; background:#0b1020; color:#e5e7eb; padding:10px 12px; border-radius:8px; font-size:13px; }
    </style>
  </head>
  <body>
    <h1>OMAR Refactor</h1>
    <p class="muted">Enter a patient DFN and ask a clinical question. This calls <code>POST /api/query/ask</code> and returns an answer with citations.</p>

    <div class="card" id="ask-card">
      <div class="row">
        <div class="narrow">
          <label for="dfn">Patient DFN</label>
          <input type="text" id="dfn" placeholder="e.g., 123" autocomplete="off" />
        </div>
        <div style="flex: 3 1 auto;">
          <label for="question">Question</label>
          <textarea id="question" placeholder="e.g., Summarize anticoagulation and any bleeding complications in the past year."></textarea>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
        <button id="askBtn">Ask Hey OMAR</button>
        <span id="status" class="muted"></span>
      </div>
    </div>

    <div class="card" id="endpoints-card">
      <h3 style="margin:0 0 8px 0;">Explore Patient APIs</h3>
      <p class="muted" style="margin-top:0;">Click to fetch JSON for Quick or VPR endpoints. Requires a DFN.</p>
      <div class="row" style="flex-wrap:wrap;">
        <div style="flex: 1 1 360px; min-width:300px;">
          <h4 style="margin:0 0 8px 0;">Quick endpoints</h4>
          <div style="display:flex; flex-wrap:wrap; gap:8px;">
            <button class="ep" data-kind="quick" data-end="demographics">/quick/demographics</button>
            <button class="ep" data-kind="quick" data-end="meds">/quick/meds</button>
            <button class="ep" data-kind="quick" data-end="labs">/quick/labs</button>
            <button class="ep" data-kind="quick" data-end="vitals">/quick/vitals</button>
            <button class="ep" data-kind="quick" data-end="problems">/quick/problems</button>
            <button class="ep" data-kind="quick" data-end="allergies">/quick/allergies</button>
            <button class="ep" data-kind="quick" data-end="notes">/quick/notes</button>
            <button class="ep" data-kind="quick" data-end="documents">/quick/documents</button>
            <button class="ep" data-kind="quick" data-end="radiology">/quick/radiology</button>
            <button class="ep" data-kind="quick" data-end="procedures">/quick/procedures</button>
            <button class="ep" data-kind="quick" data-end="encounters">/quick/encounters</button>
            <button class="ep" data-kind="quick" data-end="orders">/quick/orders</button>
          </div>
        </div>
        <div style="flex: 1 1 360px; min-width:300px;">
          <h4 style="margin:0 0 8px 0;">VPR endpoints</h4>
          <div style="display:flex; flex-wrap:wrap; gap:8px;">
            <button class="ep" data-kind="vpr" data-end="demographics">/demographics</button>
            <button class="ep" data-kind="vpr" data-end="meds">/meds</button>
            <button class="ep" data-kind="vpr" data-end="labs">/labs</button>
            <button class="ep" data-kind="vpr" data-end="vitals">/vitals</button>
            <button class="ep" data-kind="vpr" data-end="problems">/problems</button>
            <button class="ep" data-kind="vpr" data-end="allergies">/allergies</button>
            <button class="ep" data-kind="vpr" data-end="notes">/notes</button>
            <button class="ep" data-kind="vpr" data-end="documents">/documents</button>
            <button class="ep" data-kind="vpr" data-end="radiology">/radiology</button>
            <button class="ep" data-kind="vpr" data-end="procedures">/procedures</button>
            <button class="ep" data-kind="vpr" data-end="encounters">/encounters</button>
          </div>
        </div>
      </div>
      <div style="margin-top:16px;">
        <label for="custom-endpoint">Custom endpoint path</label>
        <div class="row" style="gap:8px;">
          <input type="text" id="custom-endpoint" placeholder="e.g., quick/orders?raw=1&includeRaw=1 or /api/patient/{dfn}/quick/orders" autocomplete="off" />
          <button id="custom-endpoint-btn" class="narrow" style="flex:0 0 160px;">Fetch Custom</button>
        </div>
        <p class="muted" style="margin:6px 0 0 0; font-size:13px;">Use <code>{dfn}</code> or <code>:dfn</code> as a placeholder, or leave it blank to append to the patient base.</p>
      </div>
      <div style="margin-top:12px;" class="muted" id="ep-status"></div>
    </div>

    <div class="card" id="json-card" style="display:none;">
      <h3 style="margin:0 0 8px 0;">Endpoint Result</h3>
      <div id="json-path" class="muted" style="margin-bottom:8px;"></div>
      <pre id="json-view" style="max-height:400px; overflow:auto; background:#0b1020; color:#e5e7eb; padding:12px; border-radius:8px;"></pre>
    </div>

    <div class="card" id="result-card" style="display:none;">
      <h3 style="margin:0 0 8px 0;">Answer</h3>
      <div id="answer" class="answer"></div>
      <h4 style="margin:16px 0 8px 0;">Citations</h4>
      <div id="citations" class="citations"></div>
    </div>

    <div class="card" id="debug-card" style="display:none;">
      <h3 style="margin:0 0 8px 0;">Hey OMAR Debug Trace</h3>
      <details open>
        <summary>Client → Server payload</summary>
        <pre id="debug-client" class="debug-pre"></pre>
      </details>
      <details>
        <summary>Server retrieval / RAG</summary>
        <pre id="debug-rag" class="debug-pre"></pre>
      </details>
      <details>
        <summary>Prompt sent to LLM</summary>
        <pre id="debug-prompt" class="debug-pre"></pre>
      </details>
      <details>
        <summary>LLM → Server response</summary>
        <pre id="debug-llm" class="debug-pre"></pre>
      </details>
      <details>
        <summary>Server → Client (answer + citations)</summary>
        <pre id="debug-response" class="debug-pre"></pre>
      </details>
    </div>

    <script type="module">
      import { csrfFetch, qs } from '/static/js/ui.js';

      const dfnEl = qs('#dfn');
      const qEl = qs('#question');
      const btn = qs('#askBtn');
      const statusEl = qs('#status');
      const resultCard = qs('#result-card');
      const answerEl = qs('#answer');
      const citesEl = qs('#citations');
      const debugCard = qs('#debug-card');
      const debugClientEl = qs('#debug-client');
      const debugRagEl = qs('#debug-rag');
      const debugPromptEl = qs('#debug-prompt');
      const debugLlmEl = qs('#debug-llm');
      const debugResponseEl = qs('#debug-response');

      async function ask() {
        const dfn = (dfnEl.value || '').trim();
        const prompt = (qEl.value || '').trim();
        if (!prompt) {
          statusEl.textContent = 'Enter a question.';
          return;
        }
        btn.disabled = true;
        statusEl.textContent = 'Asking…';
        answerEl.textContent = '';
        citesEl.innerHTML = '';
        resultCard.style.display = 'none';
        if (debugCard) debugCard.style.display = 'none';
        try {
          const body = dfn ? { prompt, patient: { DFN: dfn }, debug: true } : { prompt, debug: true };
          const resp = await csrfFetch('/api/query/ask', {
            method: 'POST',
            body: JSON.stringify(body)
          });
          const data = await resp.json();
          if (data.error) throw new Error(data.error);
          answerEl.textContent = data.answer || '';
          const cites = Array.isArray(data.citations) ? data.citations : [];
          for (const c of cites) {
            const div = document.createElement('div');
            div.className = 'citation';
            const ex = c.excerpt ?? '?';
            const dt = c.date ? `, Date: ${c.date}` : '';
            const tt = c.title ? `, Title: ${c.title}` : '';
            const pv = c.preview ? `\n${c.preview}` : '';
            div.textContent = `Excerpt ${ex}${dt}${tt}${pv}`;
            citesEl.appendChild(div);
          }
          resultCard.style.display = 'block';
          if (data.debug && debugCard) {
            try { debugClientEl.textContent = JSON.stringify(data.debug.client || {}, null, 2); } catch { debugClientEl.textContent = 'n/a'; }
            try { debugRagEl.textContent = JSON.stringify(data.debug.rag || {}, null, 2); } catch { debugRagEl.textContent = 'n/a'; }
            try { debugPromptEl.textContent = JSON.stringify(data.debug.prompt || {}, null, 2); } catch { debugPromptEl.textContent = 'n/a'; }
            try { debugLlmEl.textContent = JSON.stringify(data.debug.llm || {}, null, 2); } catch { debugLlmEl.textContent = 'n/a'; }
            const responseDebug = {
              answer: data.answer || '',
              citations: data.citations || [],
              ...(data.debug.response ? { response: data.debug.response } : {}),
            };
            try { debugResponseEl.textContent = JSON.stringify(responseDebug, null, 2); } catch { debugResponseEl.textContent = 'n/a'; }
            debugCard.style.display = 'block';
          }
          statusEl.textContent = '';
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Error: ' + (err?.message || 'request failed');
        } finally {
          btn.disabled = false;
        }
      }

      btn.addEventListener('click', ask);
      qEl.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') {
          ask();
        }
      });

      // Endpoint explorer
      const epStatus = qs('#ep-status');
      const jsonCard = qs('#json-card');
      const jsonView = qs('#json-view');
      const jsonPath = qs('#json-path');
      const customInput = qs('#custom-endpoint');
      const customBtn = qs('#custom-endpoint-btn');
      for (const b of document.querySelectorAll('button.ep')) {
        b.addEventListener('click', async () => {
          const dfn = (dfnEl.value || '').trim();
          if (!dfn) { epStatus.textContent = 'Enter a DFN first.'; return; }
          const kind = b.getAttribute('data-kind');
          const end = b.getAttribute('data-end');
          let url = '';
          if (kind === 'quick') {
            const params = new URLSearchParams({ raw: '1' });
            url = `/api/patient/${encodeURIComponent(dfn)}/quick/${end}?${params.toString()}`;
          } else if (kind === 'vpr') {
            url = end === 'demographics'
              ? `/api/patient/${encodeURIComponent(dfn)}/demographics`
              : `/api/patient/${encodeURIComponent(dfn)}/${end}`;
          }
          if (!url) return;
          epStatus.textContent = `GET ${url}`;
          jsonCard.style.display = 'none';
          try {
            const resp = await fetch(url, { credentials: 'same-origin' });
            const txt = await resp.text();
            let pretty = txt;
            try { const obj = JSON.parse(txt); pretty = JSON.stringify(obj, null, 2); } catch {}
            jsonView.textContent = pretty;
            jsonPath.textContent = url;
            jsonCard.style.display = 'block';
            epStatus.textContent = '';
          } catch (err) {
            epStatus.textContent = 'Error fetching endpoint.';
          }
        });
      }

      function buildCustomUrl(inputPath, dfn) {
        const path = (inputPath || '').trim();
        if (!path) return null;
        if (/^https?:\/\//i.test(path)) return path;
        const needsDfn = path.includes('{dfn}') || path.includes(':dfn');
        if (needsDfn && !dfn) return null;
        const normalized = path
          .replace('{dfn}', dfn ? encodeURIComponent(dfn) : '')
          .replace(':dfn', dfn ? encodeURIComponent(dfn) : '');
        if (normalized.startsWith('/')) return normalized;
        if (normalized.startsWith('api/')) return `/${normalized}`;
        if (!dfn) return null;
        const base = `/api/patient/${encodeURIComponent(dfn)}/`;
        return base + normalized;
      }

      async function fetchCustomEndpoint() {
        const rawPath = customInput ? customInput.value : '';
        const dfn = (dfnEl.value || '').trim();
        const url = buildCustomUrl(rawPath, dfn);
        if (!url) {
          epStatus.textContent = 'Enter a DFN or provide an absolute endpoint path.';
          return;
        }
        epStatus.textContent = `GET ${url}`;
        jsonCard.style.display = 'none';
        try {
          const resp = await fetch(url, { credentials: 'same-origin' });
          const txt = await resp.text();
          let pretty = txt;
          try { const obj = JSON.parse(txt); pretty = JSON.stringify(obj, null, 2); } catch {}
          jsonView.textContent = pretty;
          jsonPath.textContent = url;
          jsonCard.style.display = 'block';
          epStatus.textContent = '';
        } catch (err) {
          epStatus.textContent = 'Error fetching endpoint.';
        }
      }

      if (customBtn) {
        customBtn.addEventListener('click', fetchCustomEndpoint);
      }
      if (customInput) {
        customInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            fetchCustomEndpoint();
          }
        });
      }
    </script>
  </body>
  </html>
